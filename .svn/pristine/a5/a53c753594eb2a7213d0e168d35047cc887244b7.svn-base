package mvc.service;

import helper.JacksonUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Map;

/**
 * @author: xianlehuang
 * @Description:函件管理
 * @date: 2019/8/28 - 8:52
 */
@Service
public class LetterManagementService {

    @Autowired
    JdbcTemplate jdbcTemplate;

    @Autowired
    CommonServer commonServer;

    private JacksonUtil jacksonUtil = JacksonUtil.buildNormalBinder();

    //转入,转出申请查询
    public String findTransferApplication(HttpServletRequest request) {
        String startTime=request.getParameter("startTime");
        String endTime=request.getParameter("endTime");
        String vehicle=request.getParameter("vehicle");
        String type=request.getParameter("type");
        String tj="";
        if(vehicle!=null&&!vehicle.isEmpty()&&!vehicle.equals("null")&&vehicle.length()>0){
            tj +=" and a.vehicle_no='"+vehicle+"'";
        }
        if(startTime!=null&&!startTime.isEmpty()&&!startTime.equals("null")&&startTime.length()>0){
            tj +=" and a.application_time >=to_date('"+startTime+" 00:00:00','yyyy-MM-dd hh24:mi:ss')";
        }
        if(endTime!=null&&!endTime.isEmpty()&&!endTime.equals("null")&&endTime.length()>0){
            tj +=" and a.application_time <=to_date('"+endTime+"  23:59:59','yyyy-MM-dd hh24:mi:ss')";
        }
        if(type!=null&&!type.isEmpty()&&!type.equals("null")&&type.length()>0){
            tj +=" and a.JOIN_TURNOUT ='"+type+"'";
        }
//        //用户能管理的公司
//        String comps=((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("comps")==null?"":((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("comps").toString();
//        comps=comps==""?"''":comps;
//        tj +=" and (a.OLD_COMPANY in ("+comps+") or a.NEW_COMPANY in ("+comps+"))";

        String sql="select a.*,to_char(v.REGISTER_DATE,'yyyy-MM-dd hh24:mi:ss') REGISTER_DATE from tb_vehicle_application@db69 a"
                + " left join tb_vehicle@db69 v on v.vehi_no=a.vehicle_no where 1=1";
        sql += tj;
        sql += " order by a.application_time desc";
        List<Map<String, Object>> list=jdbcTemplate.queryForList(sql);
        if(list !=null){
            for (int i = 0; i < list.size(); i++) {
                list.get(i).put("AUDIT_TIME",list.get(i).get("AUDIT_TIME")==null?"":list.get(i).get("AUDIT_TIME").toString().substring(0,19));
                list.get(i).put("APPLICATION_TIME",list.get(i).get("APPLICATION_TIME")==null?"":list.get(i).get("APPLICATION_TIME").toString().substring(0,19));
                list.get(i).put("JOIN_TIME",list.get(i).get("JOIN_TIME")==null?"":list.get(i).get("JOIN_TIME").toString().substring(0,19));
                list.get(i).put("AUDIT_STATUS",list.get(i).get("AUDIT_STATUS")==null?"":String.valueOf(list.get(i).get("AUDIT_STATUS")).equals("2")?"未审核":(String.valueOf(list.get(i).get("AUDIT_STATUS")).equals("0")?"审核通过":"审核不通过"));
            }
        }
        return jacksonUtil.toJson(list);
    }

    //添加转入,转出申请
    public String addTransferApplication(HttpServletRequest request) {
        String time=request.getParameter("time");
        String companyName=request.getParameter("companyName");
        String vehicle=request.getParameter("vehicle");
        String type=request.getParameter("type");
        String[] a=vehicle.replace(")", "").split("\\(");
        int count=0;
        String cx="select count(*) from tb_vehicle_application@db69  where vehicle_no='"+a[0]+"' and audit_status ='2' and JOIN_TURNOUT ='"+type+"'";
        Integer size = jdbcTemplate.queryForObject(cx,Integer.class);
        if(size>0){
            return jacksonUtil.toJson(-1);
        }else{
            String sql="insert into tb_vehicle_application@db69 (VEHICLE_NO,OLD_COMPANY,NEW_COMPANY,APPLICATION_TIME,AUDIT_STATUS,JOIN_TIME,JOIN_TURNOUT)" +
                    "values ('"+a[0]+"','"+a[1]+"','"+companyName+"',sysdate,'2',to_date('"+time+"','yyyy-MM-dd HH24:mi:ss'),'"+type+"')";
            count = jdbcTemplate.update(sql);
            return jacksonUtil.toJson(count);
        }
    }

    //修改转入,转出申请
    public String updateTransferApplication(HttpServletRequest request) {
        String time=request.getParameter("time");
        String companyName=request.getParameter("companyName");
        String vehicle=request.getParameter("vehicle");
        String type=request.getParameter("type");
        String id=request.getParameter("id");
        String[] a=vehicle.replace(")", "").split("\\(");
        int count=0;
        String cx="select count(*) from tb_vehicle_application@db69  where vehicle_no='"+a[0]+"' and audit_status ='2' and JOIN_TURNOUT ='"+type+"' and id !='"+id+"'";
        Integer size = jdbcTemplate.queryForObject(cx,Integer.class);
        if(size>0){
            return jacksonUtil.toJson(-1);
        }else{
            String sql="update tb_vehicle_application@db69 set VEHICLE_NO='"+a[0]+"', OLD_COMPANY='"+a[1]+"',"
                    + " NEW_COMPANY='"+companyName+"',APPLICATION_TIME=sysdate, AUDIT_STATUS='2',JOIN_TIME=to_date('"+time+"','yyyy-MM-dd HH24:mi:ss'), JOIN_TURNOUT='"+type+"' where id='"+id+"'";

            count = jdbcTemplate.update(sql);
            return jacksonUtil.toJson(count);
        }
    }

    //删除转入,转出申请
    public String deleteTransferApplication(HttpServletRequest request) {
        String id = request.getParameter("id");
        int count=0;
        String sql="delete from tb_vehicle_application@db69 where id='"+id+"'";
        count = jdbcTemplate.update(sql);
        return jacksonUtil.toJson(count);
    }

    //报停申请查询
    public String findStopApplication(HttpServletRequest request) {
        String startTime=request.getParameter("startTime");
        String endTime=request.getParameter("endTime");
        String vehicle=request.getParameter("vehicle");
        String tj="";
        if(vehicle!=null&&!vehicle.isEmpty()&&!vehicle.equals("null")&&vehicle.length()>0){
            tj +=" and a.vehicle_no='"+vehicle+"'";
        }
        if(startTime!=null&&!startTime.isEmpty()&&!startTime.equals("null")&&startTime.length()>0){
            tj +=" and a.stop_time >=to_date('"+startTime+" 00:00:00','yyyy-MM-dd hh24:mi:ss')";
        }
        if(endTime!=null&&!endTime.isEmpty()&&!endTime.equals("null")&&endTime.length()>0){
            tj +=" and a.stop_time <=to_date('"+endTime+"  23:59:59','yyyy-MM-dd hh24:mi:ss')";
        }
//        //用户能管理的公司
//        String comps=((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("comps")==null?"":((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("comps").toString();
//        comps=comps==""?"''":comps;
//        tj +=" and a.COMPANY_NAME in ("+comps+")";

        String sql="select a.*,to_char(v.REGISTER_DATE,'yyyy-MM-dd hh24:mi:ss') REGISTER_DATE from tb_vehicle_stop@db69 a"
                + " left join tb_vehicle@db69 v on v.vehi_no=a.vehicle_no where 1=1";
        sql += tj;
        sql += " order by a.stop_time desc";
        List<Map<String, Object>> list=jdbcTemplate.queryForList(sql);
        if(list !=null){
            for (int i = 0; i < list.size(); i++) {
                list.get(i).put("AUDIT_TIME",list.get(i).get("AUDIT_TIME")==null?"":list.get(i).get("AUDIT_TIME").toString().substring(0,19));
                list.get(i).put("UP_TIME",list.get(i).get("UP_TIME")==null?"":list.get(i).get("UP_TIME").toString().substring(0,19));
                list.get(i).put("STOP_TIME",list.get(i).get("STOP_TIME")==null?"":list.get(i).get("STOP_TIME").toString().substring(0,19));
                list.get(i).put("AUDIT_STATUS",list.get(i).get("AUDIT_STATUS")==null?"":String.valueOf(list.get(i).get("AUDIT_STATUS")).equals("2")?"未审核":(String.valueOf(list.get(i).get("AUDIT_STATUS")).equals("0")?"审核通过":"审核不通过"));
            }
        }
        return jacksonUtil.toJson(list);
    }

    //添加报停申请
    public String addStopApplication(HttpServletRequest request) {
        String time=request.getParameter("time");
        String reason=request.getParameter("reason");
        String vehicle=request.getParameter("vehicle");
        String[] a=vehicle.replace(")", "").split("\\(");
        int count=0;
        String cx="select count(*) from tb_vehicle_stop@db69  where vehicle_no='"+a[0]+"' and audit_status ='2'";
        Integer size = jdbcTemplate.queryForObject(cx,Integer.class);
        if(size>0){
            return jacksonUtil.toJson(-1);
        }else{
            String sql="insert into tb_vehicle_stop@db69 (VEHICLE_NO,COMPANY_NAME,STOP_REASON,STOP_TIME,UP_TIME,AUDIT_STATUS)" +
                    "values ('"+a[0]+"','"+a[1]+"','"+reason+"',to_date('"+time+"','yyyy-MM-dd HH24:mi:ss'),sysdate,'2')";

            count = jdbcTemplate.update(sql);
            return jacksonUtil.toJson(count);
        }
    }

    //修改报停申请
    public String updateStopApplication(HttpServletRequest request) {
        String time=request.getParameter("time");
        String reason=request.getParameter("reason");
        String vehicle=request.getParameter("vehicle");
        String id=request.getParameter("id");
        String[] a=vehicle.replace(")", "").split("\\(");
        int count=0;
        String cx="select count(*) from tb_vehicle_stop@db69  where vehicle_no='"+a[0]+"' and audit_status ='2' and id !='"+id+"'";
        Integer size = jdbcTemplate.queryForObject(cx,Integer.class);
        if(size>0){
            return jacksonUtil.toJson(-1);
        }else{
            String sql="update tb_vehicle_stop@db69 set VEHICLE_NO='"+a[0]+"', COMPANY_NAME='"+a[1]+"',"
                    + " STOP_REASON='"+reason+"',STOP_TIME=to_date('"+time+"','yyyy-MM-dd HH24:mi:ss'),UP_TIME=sysdate, AUDIT_STATUS='2' where id='"+id+"'";
            count = jdbcTemplate.update(sql);
            return jacksonUtil.toJson(count);
        }
    }

    //删除报停申请
    public String deleteStopApplication(HttpServletRequest request) {
        String id = request.getParameter("id");
        int count=0;
        String sql="delete from tb_vehicle_stop@db69 where id='"+id+"'";
        count = jdbcTemplate.update(sql);
        return jacksonUtil.toJson(count);
    }

    //变更申请查询
    public String findChangeApplication(HttpServletRequest request) {
        String startTime=request.getParameter("startTime");
        String endTime=request.getParameter("endTime");
        String vehicle=request.getParameter("vehicle");
        String new_vehicle=request.getParameter("new_vehicle");
        String tj="";
        if(vehicle!=null&&!vehicle.isEmpty()&&!vehicle.equals("null")&&vehicle.length()>0){
            tj +=" and a.OLD_VEHICLE_NO='"+vehicle+"'";
        }
        if(new_vehicle!=null&&!new_vehicle.isEmpty()&&!new_vehicle.equals("null")&&new_vehicle.length()>0){
            tj +=" and a.NEW_VEHICLE_NO='"+new_vehicle+"'";
        }
        if(startTime!=null&&!startTime.isEmpty()&&!startTime.equals("null")&&startTime.length()>0){
            tj +=" and a.APPLY_TIME >=to_date('"+startTime+" 00:00:00','yyyy-MM-dd hh24:mi:ss')";
        }
        if(endTime!=null&&!endTime.isEmpty()&&!endTime.equals("null")&&endTime.length()>0){
            tj +=" and a.APPLY_TIME <=to_date('"+endTime+"  23:59:59','yyyy-MM-dd hh24:mi:ss')";
        }

        String sql="select a.*,to_char(v.REGISTER_DATE,'yyyy-MM-dd hh24:mi:ss') REGISTER_DATE from tb_vehicle_change@db69 a"
                + " left join tb_vehicle@db69 v on v.vehi_no=a.OLD_VEHICLE_NO where 1=1";
        sql += tj;
        sql += " order by a.APPLY_TIME desc";
        List<Map<String, Object>> list=jdbcTemplate.queryForList(sql);
        if(list !=null){
            for (int i = 0; i < list.size(); i++) {
                list.get(i).put("AUDIT_TIME",list.get(i).get("AUDIT_TIME")==null?"":list.get(i).get("AUDIT_TIME").toString().substring(0,19));
                list.get(i).put("APPLY_TIME",list.get(i).get("APPLY_TIME")==null?"":list.get(i).get("APPLY_TIME").toString().substring(0,19));
                list.get(i).put("AUDIT_STATUS",list.get(i).get("AUDIT_STATUS")==null?"":String.valueOf(list.get(i).get("AUDIT_STATUS")).equals("2")?"未审核":(String.valueOf(list.get(i).get("AUDIT_STATUS")).equals("0")?"审核通过":"审核不通过"));
            }
        }
        return jacksonUtil.toJson(list);
    }

    //添加变更申请
    public String addChangeApplication(HttpServletRequest request) {
        String vehicle=request.getParameter("vehicle");
        String new_vehicle=request.getParameter("new_vehicle");
        int count = 0;
        String cx="select count(*) from tb_vehicle_change@db69  where old_vehicle_no='"+vehicle+"' and audit_status ='2'";
        Integer size = jdbcTemplate.queryForObject(cx,Integer.class);
        if(size>0){
            return jacksonUtil.toJson(-1);
        }else{
            String sql="insert into tb_vehicle_change@db69 (OLD_VEHICLE_NO,NEW_VEHICLE_NO,APPLY_TIME,AUDIT_STATUS)" +
                    "values ('"+vehicle+"','"+new_vehicle+"',sysdate,'2')";
            count = jdbcTemplate.update(sql);
            return jacksonUtil.toJson(count);
        }
    }

    //修改变更申请
    public String updateChangeApplication(HttpServletRequest request) {
        String vehicle=request.getParameter("vehicle");
        String new_vehicle=request.getParameter("new_vehicle");
        String id = request.getParameter("id");
        int count = 0;
        String cx="select count(*) from tb_vehicle_change@db69  where old_vehicle_no='"+vehicle+"' and audit_status ='2' and id!='"+id+"'";
        Integer size = jdbcTemplate.queryForObject(cx,Integer.class);
        if(size>0){
            return jacksonUtil.toJson(-1);
        }else{
            String sql="update tb_vehicle_change@db69 set OLD_VEHICLE_NO='"+vehicle+"', NEW_VEHICLE_NO='"+new_vehicle+"',"
                    + " APPLY_TIME=sysdate, AUDIT_STATUS='2' where id='"+id+"'";
            count = jdbcTemplate.update(sql);
            return jacksonUtil.toJson(count);
        }
    }

    //删除变更申请
    public String deleteChangeApplication(HttpServletRequest request) {
        String id = request.getParameter("id");
        int count=0;
        String sql="delete from tb_vehicle_change@db69 where id='"+id+"'";
        count = jdbcTemplate.update(sql);
        return jacksonUtil.toJson(count);
    }
    //数据接入申请查询
    public String findDataApplication(HttpServletRequest request) {
        String startTime=request.getParameter("startTime");
        String endTime=request.getParameter("endTime");
        String vehicle=request.getParameter("vehicle");
        String company=request.getParameter("company");
        String tj="";
        if(startTime!=null&&!startTime.isEmpty()&&!startTime.equals("null")&&startTime.length()>0){
            tj+=" and al.application_date >=to_date('"+startTime+" 00:00:00','yyyy-MM-dd HH24:mi:ss')";
        }
        if(endTime!=null&&!endTime.isEmpty()&&!endTime.equals("null")&&endTime.length()>0){
            tj+=" and al.application_date <=to_date('"+endTime+" 23:59:59','yyyy-MM-dd HH24:mi:ss')";
        }
        if(vehicle!=null&&!vehicle.isEmpty()&&!vehicle.equals("null")&&vehicle.length()>0){
            tj+=" and al.vehicle_no ='"+vehicle+"'";
        }
        if(company!=null&&!company.isEmpty()&&!company.equals("null")&&company.length()>0){
            tj+=" and al.company_name ='"+company+"'";
        }
        String sql = "select al.*, u.REAL_NAME from TB_DATA_APPLICATION@db69 al " +
                "  left join tb_user@db69 u on al.audit_person=u.user_id" +
                " where 1=1";
        sql += tj;
        sql +=" order by al.application_date desc";
        List<Map<String, Object>> list=jdbcTemplate.queryForList(sql);
        if(list !=null){
            for (int i = 0; i < list.size(); i++) {
                list.get(i).put("APPLICATION_DATE",list.get(i).get("APPLICATION_DATE")==null?"":list.get(i).get("APPLICATION_DATE").toString().substring(0,19));
                list.get(i).put("AUDIT_DATE",list.get(i).get("AUDIT_DATE")==null?"":list.get(i).get("AUDIT_DATE").toString().substring(0,19));
                list.get(i).put("AUDIT_STATUS",list.get(i).get("AUDIT_STATUS")==null?"":String.valueOf(list.get(i).get("AUDIT_STATUS")).equals("2")?"未审核":(String.valueOf(list.get(i).get("AUDIT_STATUS")).equals("0")?"审核通过":"审核不通过"));
            }
        }
        return jacksonUtil.toJson(list);
    }
    //添加数据接入申请
    public String addDataApplication(HttpServletRequest request) {
        String vehicle=request.getParameter("vehicle");
        String company=request.getParameter("company");
        String vehicleColor=request.getParameter("vehicleColor");
        String vehicleType=request.getParameter("vehicleType");
        String fuelType=request.getParameter("fuelType");
        String terminalType=request.getParameter("terminalType");
        String terminalModel=request.getParameter("terminalModel");
        String ownerName=request.getParameter("ownerName");
        String ownerPhone=request.getParameter("ownerPhone");
        String dayPerson=request.getParameter("dayPerson");
        String nightPerson=request.getParameter("nightPerson");
        String dayPhone=request.getParameter("dayPhone");
        String nightPhone=request.getParameter("nightPhone");
        int count=0;
        String cx="select count(*) from TB_DATA_APPLICATION@db69  where vehicle_no='"+vehicle+"' and audit_status =2";
        Integer size = jdbcTemplate.queryForObject(cx,Integer.class);
        if(size>0){
            return jacksonUtil.toJson(-1);
        }else{
            String sql="insert into TB_DATA_APPLICATION@db69" +
                    " (VEHICLE_NO, VEHICLE_COLOR, VEHICLE_TYPE, FUEL_TYPE, TERMINAL_TYPE, TERMINAL_MODEL, OWNER_NAME" +
                    ", OWNER_PHONE, DAY_PERSON, NIGHT_PERSON, DAY_PHONE, NIGHT_PHONE, APPLICATION_DATE, COMPANY_NAME) " +
                    "values ('"+vehicle+"','"+vehicleColor+"','"+vehicleType+"','"+fuelType+"','"+terminalType+"','"+terminalModel+"','"+ownerName+"'," +
                    "'"+ownerPhone+"','"+dayPerson+"','"+nightPerson+"','"+dayPhone+"','"+nightPhone+"',sysdate,'"+company+"')";
            count = jdbcTemplate.update(sql);
            return jacksonUtil.toJson(count);
        }
    }
    //修改数据接入申请
    public String updateDataApplication(HttpServletRequest request) {
        String vehicle=request.getParameter("vehicle");
        String company=request.getParameter("company");
        String vehicleColor=request.getParameter("vehicleColor");
        String vehicleType=request.getParameter("vehicleType");
        String fuelType=request.getParameter("fuelType");
        String terminalType=request.getParameter("terminalType");
        String terminalModel=request.getParameter("terminalModel");
        String ownerName=request.getParameter("ownerName");
        String ownerPhone=request.getParameter("ownerPhone");
        String dayPerson=request.getParameter("dayPerson");
        String nightPerson=request.getParameter("nightPerson");
        String dayPhone=request.getParameter("dayPhone");
        String nightPhone=request.getParameter("nightPhone");
        String id = request.getParameter("id");
        int count = 0;
        String cx="select count(*) from TB_DATA_APPLICATION@db69  where vehicle_no='"+vehicle+"' and audit_status =2 and id!='"+id+"'";
        Integer size = jdbcTemplate.queryForObject(cx,Integer.class);
        if(size>0){
            return jacksonUtil.toJson(-1);
        }else{
            String sql="update TB_DATA_APPLICATION@db69 set VEHICLE_NO='"+vehicle+"', VEHICLE_COLOR='"+vehicleColor+"', VEHICLE_TYPE='"+vehicleType+"'" +
                    " ,FUEL_TYPE='"+fuelType+"', TERMINAL_TYPE='"+terminalType+"', TERMINAL_MODEL='"+terminalModel+"', OWNER_NAME='"+ownerName+"'" +
                    " ,OWNER_PHONE='"+ownerPhone+"', DAY_PERSON='"+dayPerson+"', NIGHT_PERSON='"+nightPerson+"', DAY_PHONE='"+dayPhone+"'" +
                    " ,NIGHT_PHONE='"+nightPhone+"', APPLICATION_DATE= sysdate, COMPANY_NAME='"+company+"'" +
                    ", AUDIT_STATUS=2, AUDIT_PERSON='', AUDIT_REASON='', AUDIT_DATE=''" +
                    " where id='"+id+"'";
            count = jdbcTemplate.update(sql);
            return jacksonUtil.toJson(count);
        }
    }
    //删除数据接入申请
    public String deleteDataApplication(HttpServletRequest request) {
        String id = request.getParameter("id");
        int count=0;
        String sql="delete from TB_DATA_APPLICATION@db69 where id='"+id+"'";
        count = jdbcTemplate.update(sql);
        return jacksonUtil.toJson(count);
    }

    //转入,转出统计
    public String findTransferStatistics(HttpServletRequest request) {
        String startTime=request.getParameter("startTime");
        String endTime=request.getParameter("endTime");
        String vehicle=request.getParameter("vehicle");
        String company=request.getParameter("company");
        String status=request.getParameter("status");
        String tj = "";
        if(vehicle!=null&&!vehicle.isEmpty()&&!vehicle.equals("null")&&vehicle.length()>0){
            tj +=" and a.vehicle_no='"+vehicle+"'";
        }
        if(company!=null&&!company.isEmpty()&&!company.equals("null")&&company.length()>0){
            tj +=" and a.OLD_COMPANY='"+company+"'";
        }
        if(startTime!=null&&!startTime.isEmpty()&&!startTime.equals("null")&&startTime.length()>0){
            tj +=" and a.APPLICATION_TIME >=to_date('"+startTime+"','yyyy-MM-dd hh24:mi:ss')";
        }
        if(endTime!=null&&!endTime.isEmpty()&&!endTime.equals("null")&&endTime.length()>0){
            tj +=" and a.APPLICATION_TIME <=to_date('"+endTime+"','yyyy-MM-dd hh24:mi:ss')";
        }
        if(status!=null&&!status.isEmpty()&&!status.equals("null")&&status.length()>0){
            tj +=" and a.JOIN_TURNOUT='"+status+"'";
        }
//        //用户能管理的公司
//        String comps=((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("comps")==null?"":((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("comps").toString();
//        comps=comps==""?"''":comps;
//        tj +=" and (a.OLD_COMPANY in ("+comps+") or a.NEW_COMPANY in ("+comps+"))";

        String sql="select a.vehicle_no,a.old_company,a.new_company,v.AREA_NAME,count(a.vehicle_no) count from TB_VEHICLE_APPLICATION@db69 a" +
                " left join (select v.* from tb_global_vehicle@db69 v where v.industry=090 and v.business_scope_code = 1400  AND v.STATUS_NAME='营运' AND v.PLATE_NUMBER LIKE '浙A%') v on a.vehicle_no=v.PLATE_NUMBER" +
                " where a.AUDIT_STATUS='0'";
        sql +=tj;
        sql +=" group by a.vehicle_no,a.old_company,a.new_company,v.AREA_NAME order by a.vehicle_no";
        List<Map<String, Object>>list=jdbcTemplate.queryForList(sql);
        return jacksonUtil.toJson(list);
    }

    //报停统计
    public String findStopStatistics(HttpServletRequest request) {
        String startTime=request.getParameter("startTime");
        String endTime=request.getParameter("endTime");
        String vehicle=request.getParameter("vehicle");
        String company=request.getParameter("company");
        String tj = "";
        if(vehicle!=null&&!vehicle.isEmpty()&&!vehicle.equals("null")&&vehicle.length()>0){
            tj +=" and a.vehicle_no='"+vehicle+"'";
        }
        if(company!=null&&!company.isEmpty()&&!company.equals("null")&&company.length()>0){
            tj +=" and a.COMPANY_NAME='"+company+"'";
        }
        if(startTime!=null&&!startTime.isEmpty()&&!startTime.equals("null")&&startTime.length()>0){
            tj +=" and a.UP_TIME >=to_date('"+startTime+"','yyyy-MM-dd hh24:mi:ss')";
        }
        if(endTime!=null&&!endTime.isEmpty()&&!endTime.equals("null")&&endTime.length()>0){
            tj +=" and a.UP_TIME <=to_date('"+endTime+"','yyyy-MM-dd hh24:mi:ss')";
        }
//        //用户能管理的公司
//        String comps=((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("comps")==null?"":((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("comps").toString();
//        comps=comps==""?"''":comps;
//        tj +=" and a.COMPANY_NAME in ("+comps+")";

        String sql="select a.vehicle_no,a.COMPANY_NAME,v.AREA_NAME,count(a.vehicle_no) COUNT from TB_VEHICLE_STOP@db69 a" +
                " left join (select v.* from tb_global_vehicle@db69 v where v.industry=090 and v.business_scope_code = 1400  AND v.STATUS_NAME='营运' AND v.PLATE_NUMBER LIKE '浙A%') v on a.vehicle_no=v.PLATE_NUMBER" +
                " where  a.AUDIT_STATUS='0'";
        sql +=tj;
        sql +=" group by a.vehicle_no,a.COMPANY_NAME,v.AREA_NAME";
        List<Map<String, Object>>list=jdbcTemplate.queryForList(sql);
        return jacksonUtil.toJson(list);
    }

    //变更统计
    public String findChangeStatistics(HttpServletRequest request) {
        String startTime=request.getParameter("startTime");
        String endTime=request.getParameter("endTime");
        String vehicle=request.getParameter("vehicle");
        String new_vehicle=request.getParameter("new_vehicle");
        String tj = "";
        if(vehicle!=null&&!vehicle.isEmpty()&&!vehicle.equals("null")&&vehicle.length()>0){
            tj +=" and a.old_vehicle_no='"+vehicle+"'";
        }
        if(startTime!=null&&!startTime.isEmpty()&&!startTime.equals("null")&&startTime.length()>0){
            tj +=" and a.APPLY_TIME >=to_date('"+startTime+"','yyyy-MM-dd hh24:mi:ss')";
        }
        if(endTime!=null&&!endTime.isEmpty()&&!endTime.equals("null")&&endTime.length()>0){
            tj +=" and a.APPLY_TIME <=to_date('"+endTime+"','yyyy-MM-dd hh24:mi:ss')";
        }
        if(new_vehicle!=null&&!new_vehicle.isEmpty()&&!new_vehicle.equals("null")&&new_vehicle.length()>0){
            tj +=" and a.NEW_VEHICLE_NO='"+new_vehicle+"'";
        }
        String sql="select a.old_vehicle_no,a.NEW_VEHICLE_NO,v.AREA_NAME,count(a.old_vehicle_no) count from TB_VEHICLE_CHANGE@db69 a" +
                " left join (select v.* from tb_global_vehicle@db69 v where v.industry=090 and v.business_scope_code = 1400  AND v.STATUS_NAME='营运' AND v.PLATE_NUMBER LIKE '浙A%') v on a.old_vehicle_no=v.PLATE_NUMBER" +
                " where a.AUDIT_STATUS='0'";
        sql +=tj;
        sql +=" group by a.old_vehicle_no,a.NEW_VEHICLE_NO,v.AREA_NAME  order by a.old_vehicle_no desc";
        List<Map<String, Object>>list=jdbcTemplate.queryForList(sql);
        return jacksonUtil.toJson(list);
    }

    //爱心业务用车记录查询
    public String findLoveBusinessVehicleUseRecord(HttpServletRequest request) {
        String startTime=request.getParameter("startTime");
        String endTime=request.getParameter("endTime");
        String vehicle=request.getParameter("vehicle");
        String phone=request.getParameter("phone");
        String address=request.getParameter("address");
        String tj="";
        if(startTime!=null&&!startTime.isEmpty()&&!startTime.equals("null")&&startTime.length()>0){
            tj+=" and a.DISP_TIME >=to_date('"+startTime+" 00:00:00','yyyy-MM-dd HH24:mi:ss')";
        }
        if(endTime!=null&&!endTime.isEmpty()&&!endTime.equals("null")&&endTime.length()>0){
            tj+=" and a.DISP_TIME <=to_date('"+endTime+" 23:59:59','yyyy-MM-dd HH24:mi:ss')";
        }
        if(vehicle!=null&&!vehicle.isEmpty()&&!vehicle.equals("null")&&vehicle.length()>0){
            tj+=" and a.VEHI_NO1 ='"+vehicle+"'";
        }
        if(phone!=null&&!phone.isEmpty()&&!phone.equals("null")&&phone.length()>0){
            tj+=" and a.CUST_TEL like '%"+phone+"%'";
        }
        if(address!=null&&!address.isEmpty()&&!address.equals("null")&&address.length()>0){
            tj+=" and a.ADDRESS like '%"+address+"%'";
        }
        //用户能管理的公司
        String comps=((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("comps")==null?"":((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("comps").toString();
        comps=comps==""?"''":comps;
        //用户管理的車輛
        String vehicles=((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("groupVhic")==null?"":((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("groupVhic").toString();
        tj +=" and (1=0 or a.COMP_NAME1 in ("+comps+") "+Transformation(new ArrayList<String>(Arrays.asList(vehicles.split(",")))," a.VEHI_NO1")+" )";

        String sql = "select a.* from TB_DISPATCH_LOVE@db69 a " +
                "  where a.del_flag='0' and a.ADD_WAYS=1";
        sql += tj;
        sql +=" order by a.disp_time desc";
        List<Map<String, Object>> list=jdbcTemplate.queryForList(sql);
        if(list !=null){
            for (int i = 0; i < list.size(); i++) {
                list.get(i).put("DISP_TIME",list.get(i).get("DISP_TIME")==null?"":list.get(i).get("DISP_TIME").toString().substring(0,19));
                list.get(i).put("DB_TIME",list.get(i).get("DB_TIME")==null?"":list.get(i).get("DB_TIME").toString().substring(0,19));
                list.get(i).put("AUDIT_DATE",list.get(i).get("AUDIT_DATE")==null?"":list.get(i).get("AUDIT_DATE").toString().substring(0,19));
                list.get(i).put("AUDIT_STATUS",list.get(i).get("AUDIT_STATUS")==null?"":String.valueOf(list.get(i).get("AUDIT_STATUS")).equals("2")?"未审核":(String.valueOf(list.get(i).get("AUDIT_STATUS")).equals("0")?"审核通过":"审核不通过"));

            }
        }
        return jacksonUtil.toJson(list);
    }

    //添加爱心业务用车记录
    public String addLoveBusinessVehicleUseRecord(HttpServletRequest request) {
        String CUST_TEL=request.getParameter("CUST_TEL");
        String CUST_NAME=request.getParameter("CUST_NAME");
        String DISP_TIME=request.getParameter("DISP_TIME");
        String ADDRESS=request.getParameter("ADDRESS");
        String DEST_ADDRESS=request.getParameter("DEST_ADDRESS");
        String NOTE=request.getParameter("NOTE");
        String VEHI_NO1=request.getParameter("VEHI_NO1");
        String SJDH1=request.getParameter("SJDH1");
        String SIM_NUM1=request.getParameter("SIM_NUM1");
        String COMP_NAME1=request.getParameter("COMP_NAME1");
        String YCMS=request.getParameter("YCMS");
        String TSRQ=request.getParameter("TSRQ");
        String PTQK=request.getParameter("PTQK");
        String YCXQ=request.getParameter("YCXQ");
        String SZQY=request.getParameter("SZQY");
        String JSYXM=request.getParameter("JSYXM");
        String CF=request.getParameter("CF");
        int count=0;
        String sql="insert into TB_DISPATCH_LOVE@db69" +
                " (CUST_TEL, CUST_NAME, DISP_TIME, ADDRESS, DEST_ADDRESS, NOTE, VEHI_NO1, SJDH1, SIM_NUM1, COMP_NAME1, YCMS, TSRQ, PTQK, YCXQ, SZQY, DDQY,JSYXM,CF ,ADD_WAYS) " +
                "values ('"+CUST_TEL+"','"+CUST_NAME+"',to_date('"+DISP_TIME+"','yyyy-MM-dd HH24:mi:ss'),'"+ADDRESS+"','"+DEST_ADDRESS+"','"+NOTE+"','"+VEHI_NO1+"','"+SJDH1+"','"+SIM_NUM1+"','"+COMP_NAME1+"','"+YCMS+"','"+TSRQ+"','"+PTQK+"','"+YCXQ+"','"+SZQY+"','爱心出租(人工)','"+JSYXM+"','"+CF+"',1)";
        try{
            count = jdbcTemplate.update(sql);
        }catch (Exception e){
            count=0;
        }
        return jacksonUtil.toJson(count);

    }

    //修改爱心业务用车记录
    public String updateLoveBusinessVehicleUseRecord(HttpServletRequest request) {
        String CUST_TEL=request.getParameter("CUST_TEL");
        String CUST_NAME=request.getParameter("CUST_NAME");
        String DISP_TIME=request.getParameter("DISP_TIME");
        String ADDRESS=request.getParameter("ADDRESS");
        String DEST_ADDRESS=request.getParameter("DEST_ADDRESS");
        String NOTE=request.getParameter("NOTE");
        String VEHI_NO1=request.getParameter("VEHI_NO1");
        String SJDH1=request.getParameter("SJDH1");
        String SIM_NUM1=request.getParameter("SIM_NUM1");
        String COMP_NAME1=request.getParameter("COMP_NAME1");
        String YCMS=request.getParameter("YCMS");
        String TSRQ=request.getParameter("TSRQ");
        String PTQK=request.getParameter("PTQK");
        String YCXQ=request.getParameter("YCXQ");
        String SZQY=request.getParameter("SZQY");
        String id = request.getParameter("id");
        String JSYXM=request.getParameter("JSYXM");
        String CF=request.getParameter("CF");
        int count=0;
        String sql="update TB_DISPATCH_LOVE@db69 set CUST_TEL='"+CUST_TEL+"'" +
                " ,CUST_NAME='"+CUST_NAME+"'" +
                " ,DISP_TIME=to_date('"+DISP_TIME+"','yyyy-MM-dd HH24:mi:ss')" +
                " ,ADDRESS='"+ADDRESS+"'" +
                " ,DEST_ADDRESS='"+DEST_ADDRESS+"'" +
                " ,NOTE='"+NOTE+"'" +
                " ,VEHI_NO1='"+VEHI_NO1+"'" +
                " ,SJDH1='"+SJDH1+"'" +
                " ,SIM_NUM1='"+SIM_NUM1+"'" +
                " ,COMP_NAME1='"+COMP_NAME1+"'" +
                " ,YCMS='"+YCMS+"'" +
                " ,TSRQ='"+TSRQ+"'" +
                " ,PTQK='"+PTQK+"'" +
                " ,YCXQ='"+YCXQ+"'" +
                " ,SZQY='"+SZQY+"'" +
                " ,JSYXM='"+JSYXM+"'" +
                " ,CF='"+CF+"'" +
                " where DISP_ID='"+id+"'";
        try{
            count = jdbcTemplate.update(sql);
        }catch (Exception e){
            count=0;
        }
        return jacksonUtil.toJson(count);
    }

    //删除爱心业务用车记录
    public String deleteLoveBusinessVehicleUseRecord(HttpServletRequest request) {
        String id = request.getParameter("id");
        int count=0;
        String sql="update TB_DISPATCH_LOVE@db69 set del_flag='1'" +
                " where DISP_ID='"+id+"'";
        try{
            count = jdbcTemplate.update(sql);
        }catch (Exception e){
            count=0;
        }
        return jacksonUtil.toJson(count);
    }

    //车辆驾驶员管理查询
    public String findVehicleDiverManagement(HttpServletRequest request) {
        String driver_name=request.getParameter("driver_name");
        String phone=request.getParameter("phone");
        String shift_address=request.getParameter("shift_address");
        String vehicle=request.getParameter("vehicle");
        String unit_name=request.getParameter("unit_name");
        String tj="";
        if(driver_name!=null&&!driver_name.isEmpty()&&!driver_name.equals("null")&&driver_name.length()>0){
            tj+=" and a.driver_name like '%"+driver_name+"%'";
        }
        if(phone!=null&&!phone.isEmpty()&&!phone.equals("null")&&phone.length()>0){
            tj+=" and a.phone like '%"+phone+"%'";
        }
        if(shift_address!=null&&!shift_address.isEmpty()&&!shift_address.equals("null")&&shift_address.length()>0){
            tj+=" and a.shift_address like '%"+shift_address+"%'";
        }
        if(vehicle!=null&&!vehicle.isEmpty()&&!vehicle.equals("null")&&vehicle.length()>0){
            tj+=" and a.vehicle_no ='"+vehicle+"'";
        }
        if(unit_name!=null&&!unit_name.isEmpty()&&!unit_name.equals("null")&&unit_name.length()>0){
            tj+=" and a.unit_name ='"+unit_name+"'";
        }
        //用户能管理的公司
        String comps=((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("comps")==null?"":((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("comps").toString();
        comps=comps==""?"''":comps;
        //用户管理的車輛
        String vehicles=((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("groupVhic")==null?"":((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("groupVhic").toString();
        tj +=" and (1=0 or a.COMPANY_NAME in ("+comps+") "+Transformation(new ArrayList<String>(Arrays.asList(vehicles.split(",")))," a.vehicle_no")+" )";

        String sql = "select a.* from tb_unit_driver a " +
                "  where a.del_flag='0'";
        sql += tj;
        sql +=" order by a.DB_TIME desc";
        List<Map<String, Object>> list=jdbcTemplate.queryForList(sql);
        if(list !=null){
            for (int i = 0; i < list.size(); i++) {
                list.get(i).put("BIRTH_DATE",list.get(i).get("BIRTH_DATE")==null?"":list.get(i).get("BIRTH_DATE").toString().substring(0,10));
                list.get(i).put("DB_TIME",list.get(i).get("DB_TIME")==null?"":list.get(i).get("DB_TIME").toString().substring(0,19));
                list.get(i).put("AUDIT_DATE",list.get(i).get("AUDIT_DATE")==null?"":list.get(i).get("AUDIT_DATE").toString().substring(0,19));
                list.get(i).put("AUDIT_STATUS",list.get(i).get("AUDIT_STATUS")==null?"":String.valueOf(list.get(i).get("AUDIT_STATUS")).equals("2")?"未审核":(String.valueOf(list.get(i).get("AUDIT_STATUS")).equals("0")?"审核通过":"审核不通过"));

            }
        }
        return jacksonUtil.toJson(list);
    }

    //添加车辆驾驶员管理
    public String addVehicleDiverManagement(HttpServletRequest request) {
        String DRIVER_NAME=request.getParameter("DRIVER_NAME");
        String SEX=request.getParameter("SEX");
        String BIRTH_DATE=request.getParameter("BIRTH_DATE");
        String POLITICAL_AFFILIATION=request.getParameter("POLITICAL_AFFILIATION");
        String VEHICLE_NO=request.getParameter("VEHICLE_NO");
        String COMPANY_NAME=request.getParameter("COMPANY_NAME");
        String UNIT_NAME=request.getParameter("UNIT_NAME");
        String SHIFTS=request.getParameter("SHIFTS");
        String SHIFT_TIME=request.getParameter("SHIFT_TIME");
        String SHIFT_ADDRESS=request.getParameter("SHIFT_ADDRESS");
        String PHONE=request.getParameter("PHONE");
        String FUEL_TYPE=request.getParameter("FUEL_TYPE");
        String QUALIFICATION_NUMBER=request.getParameter("QUALIFICATION_NUMBER");
        String ADDRESS=request.getParameter("ADDRESS");
        String REMARKS=request.getParameter("REMARKS");
        int count=0;
        String cx="select count(*) from tb_unit_driver where vehicle_no='"+VEHICLE_NO+"' and del_flag='0'";
        Integer size = jdbcTemplate.queryForObject(cx,Integer.class);
        if(size>0){
            return jacksonUtil.toJson(-1);
        }else{
            String sql="insert into tb_unit_driver" +
                    " (DRIVER_NAME, SEX, BIRTH_DATE, POLITICAL_AFFILIATION, VEHICLE_NO, COMPANY_NAME, UNIT_NAME, SHIFTS, SHIFT_TIME, SHIFT_ADDRESS, PHONE, FUEL_TYPE, QUALIFICATION_NUMBER, ADDRESS, REMARKS) " +
                    "values ('"+DRIVER_NAME+"','"+SEX+"',to_date('"+BIRTH_DATE+"','yyyy-MM-dd'),'"+POLITICAL_AFFILIATION+"','"+VEHICLE_NO+"','"+COMPANY_NAME+"','"+UNIT_NAME+"','"+SHIFTS+"','"+SHIFT_TIME+"','"+SHIFT_ADDRESS+"','"+PHONE+"','"+FUEL_TYPE+"','"+QUALIFICATION_NUMBER+"','"+ADDRESS+"','"+REMARKS+"')";
            try{
                count = jdbcTemplate.update(sql);
            }catch (Exception e){
                count=0;
            }
        }
        return jacksonUtil.toJson(count);
    }

    //修改车辆驾驶员管理
    public String updateVehicleDiverManagement(HttpServletRequest request) {
        String DRIVER_NAME=request.getParameter("DRIVER_NAME");
        String SEX=request.getParameter("SEX");
        String BIRTH_DATE=request.getParameter("BIRTH_DATE");
        String POLITICAL_AFFILIATION=request.getParameter("POLITICAL_AFFILIATION");
        String VEHICLE_NO=request.getParameter("VEHICLE_NO");
        String COMPANY_NAME=request.getParameter("COMPANY_NAME");
        String UNIT_NAME=request.getParameter("UNIT_NAME");
        String SHIFTS=request.getParameter("SHIFTS");
        String SHIFT_TIME=request.getParameter("SHIFT_TIME");
        String SHIFT_ADDRESS=request.getParameter("SHIFT_ADDRESS");
        String PHONE=request.getParameter("PHONE");
        String FUEL_TYPE=request.getParameter("FUEL_TYPE");
        String QUALIFICATION_NUMBER=request.getParameter("QUALIFICATION_NUMBER");
        String ADDRESS=request.getParameter("ADDRESS");
        String REMARKS=request.getParameter("REMARKS");
        String id = request.getParameter("id");
        int count=0;
        String cx="select count(*) from tb_unit_driver where vehicle_no='"+VEHICLE_NO+"' and del_flag='0' and ID !='"+id+"'";
        Integer size = jdbcTemplate.queryForObject(cx,Integer.class);
        if(size>0){
            return jacksonUtil.toJson(-1);
        }else{
            String sql="update tb_unit_driver set DRIVER_NAME='"+DRIVER_NAME+"'" +
                    " ,SEX='"+SEX+"'" +
                    " ,BIRTH_DATE=to_date('"+BIRTH_DATE+"','yyyy-MM-dd')" +
                    " ,POLITICAL_AFFILIATION='"+POLITICAL_AFFILIATION+"'" +
                    " ,VEHICLE_NO='"+VEHICLE_NO+"'" +
                    " ,COMPANY_NAME='"+COMPANY_NAME+"'" +
                    " ,UNIT_NAME='"+UNIT_NAME+"'" +
                    " ,SHIFTS='"+SHIFTS+"'" +
                    " ,SHIFT_TIME='"+SHIFT_TIME+"'" +
                    " ,SHIFT_ADDRESS='"+SHIFT_ADDRESS+"'" +
                    " ,PHONE='"+PHONE+"'" +
                    " ,FUEL_TYPE='"+FUEL_TYPE+"'" +
                    " ,QUALIFICATION_NUMBER='"+QUALIFICATION_NUMBER+"'" +
                    " ,ADDRESS='"+ADDRESS+"'" +
                    " ,REMARKS='"+REMARKS+"'" +
                    " where ID='"+id+"'";
            try{
                count = jdbcTemplate.update(sql);
            }catch (Exception e){
                count=0;
            }
        }
        return jacksonUtil.toJson(count);
    }

    //删除车辆驾驶员管理
    public String deleteVehicleDiverManagement(HttpServletRequest request) {
        String id = request.getParameter("id");
        int count=0;
        String sql="update tb_unit_driver set del_flag='1'" +
                " where ID='"+id+"'";
        try{
            count = jdbcTemplate.update(sql);
        }catch (Exception e){
            count=0;
        }
        return jacksonUtil.toJson(count);
    }

    public String Transformation(ArrayList<String> list,String field){
        String loginType = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("loginType")==null?"":((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getSession().getAttribute("loginType").toString();
        String vehicleGroupId = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getParameter("vehicleGroupId")==null?"":((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest().getParameter("vehicleGroupId").toString();
        //判断登录类型
        if("1".equals(loginType)){
            //判断查询条件是否有车辆组id，有：获取对应车辆组id的车辆，没有：获取改用户下的全部车辆
            if(vehicleGroupId!=null&&!vehicleGroupId.isEmpty()&&!vehicleGroupId.equals("null")){
                list = new ArrayList<String>(Arrays.asList(commonServer.getGroupVehicles(vehicleGroupId).split(",")));
            }
            if(list.size()==1&&"".equals(list.get(0))){
                return " or "+field + "in ('') ";
            }else{
                int init = 900;// 每隔100条循环一次
                int total = list.size();
                int cycelTotal = total / init;
                if (total % init != 0) {
                    cycelTotal += 1;
                    if (total < init) {
                        init = list.size();
                    }
                }
                ArrayList<String> cphm = new ArrayList<String>();
                ArrayList<String> list2 = new ArrayList<String>();
                for (int i = 0; i < cycelTotal; i++) {
                    for (int j = 0; j < init; j++) {
                        try {
                            if (list.get(j) == null) {
                                break;
                            }
                            list2.add(list.get(j));
                        } catch (Exception e) {
                        }
                    }
                    cphm.add("'"+String.join( "','",list2)+"'");
                    list.removeAll(list2);//移出已经保存过的数据
                    list2.clear();//移出当前保存的数据
                }
                String tj = " or ( ";
                if(cphm.size() ==1){
                    tj += field+" in ("+cphm.get(0)+") ";
                }else{
                    for (int i = 0; i < cphm.size(); i++) {
                        if(i == 0){
                            tj += field +" in ("+cphm.get(i)+") ";
                        }else{
                            tj += " or "+field+" in ("+cphm.get(i)+") ";
                        }
                    }
                }
                tj += " ) ";
                return tj;
            }
        }else{
            return "";
        }
    }

    public String getSjhmSelect(HttpServletRequest request) {
        String sjhm = String.valueOf(request.getParameter("sjhm"));
        String sql = "select distinct CUST_TEL from TB_DISPATCH_LOVE@db69 where CUST_TEL like '%"+sjhm+"%' order by cust_tel";
        List<Map<String, Object>> list = jdbcTemplate.queryForList(sql);
        return jacksonUtil.toJson(list);
    }

    public String getSjhmInfo(HttpServletRequest request) {
        String sjhm = String.valueOf(request.getParameter("sjhm"));
        String sql = "select * from TB_DISPATCH_LOVE@db69 where CUST_TEL = '"+sjhm+"' order by disp_time desc";
        List<Map<String, Object>> list = jdbcTemplate.queryForList(sql);
        return jacksonUtil.toJson(list);
    }
}
